From 50d631b815f90b3b26153676ee9c9e55b4fd6d6f Mon Sep 17 00:00:00 2001
From: Karel Zak <kzak@redhat.com>
Date: Wed, 1 Feb 2017 11:58:09 +0100
Subject: [PATCH] su: properly clear child PID
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reported-by: Tobias St√∂ckmann <tobias@stoeckmann.org>
Signed-off-by: Karel Zak <kzak@redhat.com>

Upstream-commit: dffab154d29a288aa171ff50263ecc8f2e14a891
Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 src/su.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/src/su.c b/src/su.c
index ce0ff75..0b4aa3e 100644
--- a/src/su.c
+++ b/src/su.c
@@ -644,6 +644,9 @@ run_shell (char const *shell, char const *command, char **additional_args,
           }
         else
           status = WEXITSTATUS (status);
+
+        /* child is gone, don't use the PID anymore */
+        child = (pid_t) -1;
       }
       else if (caught)
         status = caught + 128;
@@ -653,7 +656,7 @@ run_shell (char const *shell, char const *command, char **additional_args,
   else
     status = 1;
 
-  if (caught) {
+  if (caught && child != (pid_t)-1) {
     fprintf(stderr, "\nSession terminated, killing shell...");
     kill (child, SIGTERM);
   }
@@ -664,9 +667,12 @@ run_shell (char const *shell, char const *command, char **additional_args,
   retval = pam_end(pamh, PAM_SUCCESS);
   PAM_BAIL_P_VOID;
   if (caught) {
-    sleep(2);
-    kill(child, SIGKILL);
-    fprintf(stderr, " ...killed.\n");
+    if (child != (pid_t)-1)
+    {
+      sleep(2);
+      kill(child, SIGKILL);
+      fprintf(stderr, " ...killed.\n");
+    }
     switch (caught) {
         case SIGTERM:
           sigaction(SIGTERM, &oldact[0], NULL);
-- 
2.7.4

